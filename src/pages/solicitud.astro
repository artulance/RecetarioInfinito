---
import AboutHeroImage from '../assets/aportaciones.jpg';
import Layout from '../layouts/BlogPost.astro';
---

<Layout
	title="Sobre el Proyecto Recetario Infinito"
	description="Conoce la metodología y filosofía detrás de Recetario Infinito"
	pubDate={new Date('November 11 2025')}
	heroImage={AboutHeroImage}
>

	<p>
		Creamos recetas poco comunes de una manera poco común, si quieres alguna receta original cuentanos tu idea y la estudiaremos para publicarla en la sección de recetas <a href="/solicitadas" class="underline" target="_self" title="Apartado propuestas">aportaciones</a>.
	</p>

	<p>
		<strong>Únete a la Comunidad:</strong> Si tienes una solicitud especial o quieres compartir tus propias creaciones culinarias, ¡contáctanos! Estamos aquí para hacer que tu experiencia en la cocina sea inolvidable.
	</p>
	<form id="requestForm" class="max-w-2xl mx-auto mt-8 space-y-4 bg-white p-6 rounded-lg shadow">
		<label class="block">
			<span class="text-sm font-medium">Nombre</span>
			<input name="name" type="text" required maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-pink-200" />
		</label>

		<label class="block">
			<span class="text-sm font-medium">Email</span>
			<input name="email" type="email" required maxlength="254" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-pink-200" />
		</label>

		<label class="block">
			<span class="text-sm font-medium">Solicitud (máx 250 caracteres)</span>
			<textarea name="message" id="message" rows="5" maxlength="250" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-pink-200"></textarea>
			<div class="text-xs text-gray-500 mt-1"><span id="charCount">0</span>/250</div>
		</label>

		<div class="flex items-center justify-between">
			<button type="submit" class="px-4 py-2 bg-pink-500 text-white rounded-md">Enviar solicitud</button>
			<div id="formFeedback" class="text-sm text-red-600"></div>
		</div>
	</form>

</Layout>

<script>
// Client-side form submission: intercept form and POST to /submit.php
document.addEventListener('DOMContentLoaded', () => {
	const form = document.getElementById('requestForm');
	if (!form) return;
	const feedback = document.getElementById('formFeedback');

	// Contar caracteres para el textarea
	const messageEl = document.getElementById('message');
	const charCountEl = document.getElementById('charCount');
	if (messageEl && charCountEl) {
		const updateCount = () => {
			const len = messageEl.value.length;
			charCountEl.textContent = String(len);
		};
		messageEl.addEventListener('input', updateCount);
		// initialize
		updateCount();
	}
	// fin contar caracteres

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		feedback.textContent = '';

		const formData = new FormData(form);
		// Basic client validation
		const name = (formData.get('name') || '').toString().trim();
		const email = (formData.get('email') || '').toString().trim();
		const message = (formData.get('message') || '').toString().trim();

		if (!name || name.length > 100) {
			feedback.textContent = 'Nombre inválido (máx 100 caracteres).';
			return;
		}
		if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
			feedback.textContent = 'Email inválido.';
			return;
		}
		if (!message || message.length > 250) {
			feedback.textContent = 'El mensaje es obligatorio y máximo 250 caracteres.';
			return;
		}

        

		try {
			const res = await fetch('https://artulance.com/submit.php', {
			// const res = await fetch('http://localhost/submit.php', {
				method: 'POST',
				body: formData,
			});

			// Safely read response as text then try to parse JSON to avoid
			// "Unexpected end of JSON input" when body is empty or not JSON.
			const text = await res.text();
			let json = null;
			if (text) {
				try {
					json = JSON.parse(text);
				} catch (e) {
					// Non-JSON response, keep json as null
					json = null;
				}
			}

			if (res.ok) {
				if (json && json.success) {
					feedback.textContent = json.message || 'Enviado correctamente.';
					form.reset();
					if (charCountEl) charCountEl.textContent = '0';
				} else if (json && (json.errors || json.message)) {
					feedback.textContent = (json.errors || json.message).toString();
				} else {
					// No JSON but 2xx response — consider it success or give a friendly message
					feedback.textContent = 'Enviado correctamente.';
					form.reset();
					if (charCountEl) charCountEl.textContent = '0';
				}
			} else {
				// Non-2xx response
				if (json) {
					feedback.textContent = (json.errors || json.message || 'Error al enviar').toString();
				} else {
					feedback.textContent = `Error del servidor: ${res.status} ${res.statusText}`;
				}
			}
		} catch (err) {
			feedback.textContent = 'Error de red: ' + (err && err.message ? err.message : String(err));
		}
	});
});
</script>
